- name: Install prerequisites (Amazon Linux)
  become: true
  yum:
    name:
      - yum-utils
      - device-mapper-persistent-data
      - lvm2
      # - curl
    state: present

- name: Add Docker repository
  become: true
  get_url:
    url: https://download.docker.com/linux/centos/docker-ce.repo
    dest: /etc/yum.repos.d/docker-ce.repo

- name: Install Docker
  become: true
  yum:
    name: docker
    state: latest

- name: Start Docker service
  become: true
  service:
    name: docker
    state: started
    enabled: true

- name: Create app directory
  become: true
  file:
    path: /opt/app
    state: directory
    owner: ec2-user
    group: ec2-user
    mode: '0755'

- name: Copy application files (optional if you're using volumes)
  become: true
  copy:
    src: ./app/
    dest: /opt/app/
    mode: '0755'
  when: app_dir is defined  # Optional: add var check if needed

- name: Run Web App Container
  become: true
  docker_container:
    name: hello-app
    image: nginx
    state: started
    ports:
      - "80:80"
    # # command: "node /app/server.js"
    # volumes:
    #   - "/opt/app:/app"
